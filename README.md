# チャットボット

## 機能
- 自然言語処理による対話
  - 表記ゆれの自動吸収
  - 曖昧な質問への適切な対応
  - 感情分析に基づく応答調整
  - エンティティ抽出による文脈理解
- ユーザー認証
- データベース統合
- パフォーマンスモニタリング
- キャッシュ機能
- 非同期処理
- 管理画面

## 必要条件
- Python 3.8以上
- SQLite（開発環境用）
- Redis（オプション）

## セットアップ手順

### 1. 環境の準備
```bash
# プロジェクトディレクトリに移動
cd chatbot/backend

# 仮想環境の作成
python -m venv venv

# 仮想環境の有効化
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate
```

### 2. 必要なパッケージのインストール
```bash
# 基本的な依存パッケージのインストール
pip install -r requirements.txt

# 追加で必要なパッケージのインストール
pip install email-validator  # メールアドレス検証用
pip install sentencepiece   # 日本語トークナイザー用
```

### 3. データベースの初期化
```bash
# データベースの初期化（自動的に実行されます）
python main.py
```

### 4. サーバーの起動
```bash
# 開発サーバーの起動
python main.py
```

サーバーが起動すると、以下のエンドポイントが利用可能になります：
- API: http://localhost:8000
- APIドキュメント: http://localhost:8000/docs

### 5. 初期管理者アカウントの設定
```bash
# 管理者アカウントの作成
# Linux/Mac:
curl -X POST http://localhost:8000/api/setup/admin

# Windows (PowerShell):
Invoke-WebRequest -Method POST -Uri http://localhost:8000/api/setup/admin

# 作成される管理者アカウントの認証情報
メールアドレス: admin@example.com
パスワード: admin123
```

### 6. ログインとアクセストークンの取得
```bash
# アクセストークンの取得
# Linux/Mac:
curl -X POST http://localhost:8000/api/token \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@example.com&password=admin123"

# Windows (PowerShell):
$body = @{
    username = "admin@example.com"
    password = "admin123"
}
Invoke-WebRequest -Method POST -Uri http://localhost:8000/api/token `
  -ContentType "application/x-www-form-urlencoded" `
  -Body $body

# レスポンス例
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1...",
  "token_type": "bearer"
}
```

### 7. 管理者ユーザーのセットアップ手順

1. ブラウザで http://localhost:8000/api/setup/admin にアクセスします。
2. 管理者ユーザーが存在しない場合、自動的に作成されます。
3. 作成後、http://localhost:8000/login にリダイレクトされます。
4. ログインページで以下の認証情報を使用してログインします：
   - メールアドレス: admin@example.com
   - パスワード: admin123

注意事項：
- 管理者ユーザーは一度だけ作成できます。
- 既に管理者ユーザーが存在する場合は、エラーメッセージが表示されます。
- セキュリティのため、本番環境では初期パスワードを必ず変更してください。

## 主なエンドポイント
- POST /register: ユーザー登録
- POST /token: ログイン（トークン取得）
- POST /chat: チャットメッセージの送信
- GET /profile: ユーザープロフィールの取得
- PUT /profile: プロフィールの更新
- POST /chats/search: チャット履歴の検索
- GET /admin/metrics: 管理者用メトリクス（管理者のみ）

## 自然言語処理機能
1. **表記ゆれの自動吸収**:
   - 全角/半角文字の統一
   - ひらがな/カタカナの表記ゆれ対応
   - 敬語表現のバリエーション対応
   - 句読点や記号の違いを吸収

2. **曖昧な質問への対応**:
   - 関連する意図の自動検出
   - 明確化の質問を生成
   - 複数の可能性を提示
   - 文脈に基づく意図の推測

3. **感情分析**:
   - ユーザーの感情を分析
   - ネガティブな感情への適切な対応
   - 感情に配慮した応答生成
   - エスカレーションの判断

4. **エンティティ抽出**:
   - 人名、地名、日付などの抽出
   - 数値や単位の認識
   - 固有名詞の特定
   - 文脈に基づく応答の生成

5. **応答生成の最適化**:
   - 文脈に応じた応答の選択
   - エンティティの動的な置換
   - 感情に配慮した応答の調整
   - 曖昧さの解消

## 管理画面
1. アクセス方法:
- 管理者アカウントでログイン後、自動的に管理画面にリダイレクトされます
- または、ログイン後に `/admin` にアクセス

2. 管理者アカウントの初期設定:
```bash
# 管理者アカウントの作成（初回のみ）
# Windows (PowerShell):
Invoke-WebRequest -Method POST -Uri http://localhost:8080/api/setup/admin

# Linux/Mac:
curl -X POST http://localhost:8080/api/setup/admin

# 初期管理者アカウント
メールアドレス: admin@example.com
パスワード: admin123
```

3. 管理機能:
- システムメトリクス
  - 総ユーザー数
  - アクティブユーザー数
  - 総チャット数
  - 総メッセージ数
- 最近のアクティビティ
  - アクティビティの種類
  - 発生日時

4. セキュリティ:
- JWT認証による管理者権限の確認
- 非管理者のアクセスを自動的にブロック
- 管理者権限の動的チェック
- セッション管理

5. フロントエンド開発環境のセットアップ:
```bash
# プロジェクトディレクトリに移動
cd chatbot/frontend

# 依存パッケージのインストール
npm install

# 開発サーバーの起動
npm run dev
```

フロントエンドサーバーが起動すると、以下のURLでアクセス可能になります：
- アプリケーション: http://localhost:3000
- 管理画面: http://localhost:3000/admin

## 開発
- APIドキュメント: http://localhost:8000/docs
- リバースエンジニアリング: http://localhost:8000/redoc

## 表示モード
1. **ダークモード**:
   - 画面右上の太陽/月アイコンでモード切り替え
   - チャット画面全体のカラーテーマを変更
   - メッセージの背景色も自動調整
   - シークレットモードと併用可能

2. **シークレットモード**:
   - チャット履歴を保存しない秘密会話
   - 検索結果から除外
   - プライバシー保護

3. **使用方法**:
```bash
# シークレットモードでチャットを開始（Linux/Mac）:
curl -X POST http://localhost:8000/api/chat \
  -H "Authorization: Bearer あなたのアクセストークン" \
  -H "Content-Type: application/json" \
  -d '{"messages": [{"role": "user", "content": "こんにちは"}], "is_secret": true}'

# シークレットモードでチャットを開始（Windows PowerShell）:
$body = @{
    messages = @(
        @{
            role = "user"
            content = "こんにちは"
        }
    )
    is_secret = $true
} | ConvertTo-Json

Invoke-WebRequest -Method POST -Uri http://localhost:8000/api/chat `
  -Headers @{Authorization = "Bearer あなたのアクセストークン"} `
  -ContentType "application/json" `
  -Body $body
```

## スマートフォン対応
1. **最適化機能**:
   - レスポンシブデザイン対応
   - 入力欄の固定表示
   - スクロール時の操作性向上
   - タッチ操作の最適化

2. **UI/UX改善**:
   - メッセージ入力欄が常に表示され、潰れない設計
   - 入力欄の最小高さ保証（100px）
   - メッセージ表示エリアの自動スクロール
   - 視覚的な区切りの強化（影効果）

3. **入力機能**:
   - テキスト入力の高さ制限（40px-80px）
   - 音声入力ボタンの固定サイズ（180px）
   - 送信ボタンの最適化（40px）
   - 入力中の快適な操作性

4. **アクセシビリティ**:
   - 適切なコントラスト比
   - タッチターゲットの最適化
   - スクロール位置の自動調整
   - キーボード操作のサポート

5. **パフォーマンス**:
   - スムーズなスクロール挙動
   - 効率的なレイアウト計算
   - メモリ使用量の最適化
   - レスポンシブな表示切り替え

## ライセンス
MIT 

## 環境設定

### バックエンド (FastAPI)
```bash
# バックエンドサーバーの起動（デフォルトポート: 8000）
cd chatbot/backend
python main.py
```

### フロントエンド (Vue.js)
```bash
# フロントエンドサーバーの起動（デフォルトポート: 3000）
cd chatbot/frontend
npm install
npm run dev
```

## 初期セットアップ

### 1. 管理者アカウントの作成
管理者アカウントを作成するには2つの方法があります：

#### 方法1: APIエンドポイントを直接呼び出す
```bash
# Windows (PowerShell):
Invoke-WebRequest -Method POST -Uri http://localhost:8000/api/setup/admin

# Linux/Mac:
curl -X POST http://localhost:8000/api/setup/admin
```

#### 方法2: ブラウザからアクセス
1. ブラウザで `http://localhost:8000/api/setup/admin` にアクセス
2. 管理者アカウントが自動的に作成されます

### 2. 管理者アカウントでログイン
```
メールアドレス: admin@example.com
パスワード: admin123
```

### 3. 管理画面の機能
- システムメトリクス表示
  - 総ユーザー数
  - アクティブユーザー数
  - 総チャット数
  - 総メッセージ数
  - 平均応答時間
- システム状態モニタリング
  - システム健全性
  - メモリ使用率
  - CPU使用率
- 最近のアクティビティログ
  - ユーザーログイン/ログアウト
  - チャットアクティビティ
  - システムイベント

### 4. スクロール機能の最適化
- メッセージ表示エリア
  - 画面高さに応じた自動調整（vh - 280px）
  - スムーズスクロール効果
  - カスタマイズされたスクロールバー
    - 幅: 8px
    - 角丸デザイン
    - ホバーエフェクト
  - スクロールパフォーマンスの最適化
    - ハードウェアアクセラレーション対応
    - will-change プロパティの活用

### 5. アニメーションとトランジション
- メッセージ表示アニメーション
  - フェードイン効果（0.3秒）
  - 下から上へのスライド
  - スムーズな表示切り替え
- 視覚的フィードバック
  - スクロールバーのホバー効果
  - メッセージ間の適切な余白（16px）

### 6. レスポンシブ対応の強化
- 画面サイズに応じた自動調整
  - メッセージコンテナの高さ
  - 入力欄の固定位置
  - スクロール領域の最適化
- モバイルデバイス対応
  - タッチスクロールの最適化
  - 慣性スクロール対応
  - 入力欄の安定表示

### 7. パフォーマンス最適化
- スクロール処理
  - transform: translateZ(0) による最適化
  - will-change プロパティによる事前最適化
  - スムーズスクロールの実装
- メモリ使用量
  - 効率的なDOMレンダリング
  - アニメーション最適化
  - 不要な再描画の防止

### 8. アクセシビリティ
- スクロールバーのカスタマイズ
  - 十分なコントラスト比
  - クリック可能な領域の確保
  - 視認性の向上
- キーボード操作
  - スクロール操作のサポート
  - フォーカス管理の改善

### 9. トラブルシューティング
- スクロールが動作しない場合
  1. ブラウザのキャッシュをクリア
  2. ページを完全リロード（Ctrl + F5）
  3. 開発者ツールでエラーを確認
- 表示が崩れる場合
  1. ズームレベルを100%に設定
  2. 画面サイズを確認
  3. CSSの再読み込み

## 注意事項
1. バックエンドサーバー（FastAPI）は必ずポート8000で起動してください
2. 初期管理者アカウントのパスワードは必ず変更してください
3. 本番環境では適切なセキュリティ設定を行ってください

## トラブルシューティング
1. ログインできない場合
   - バックエンドサーバーが起動していることを確認
   - ポート番号が8000であることを確認
   - 認証情報が正しいことを確認

2. 管理画面にアクセスできない場合
   - 管理者権限が正しく設定されているか確認
   - ログアウト後に再度ログインを試す

3. メトリクスが表示されない場合
   - ブラウザの開発者ツールでネットワークエラーを確認
   - バックエンドのログを確認

## フロントエンドのセットアップ

### 1. 環境の準備
```bash
# プロジェクトディレクトリに移動
cd chatbot/frontend

# 依存パッケージのインストール
npm install
# または
yarn install
```

### 2. 開発サーバーの起動
```bash
# 開発サーバーの起動
npm run serve
# または
yarn serve
```

フロントエンドサーバーが起動すると、以下のURLでアクセス可能になります：
- ローカル: http://localhost:8081
- ネットワーク: http://[あなたのIPアドレス]:8081

## 注意事項
- フロントエンドは8081ポートで動作します
- バックエンドは8000ポートで動作します
- メッセージの送信時は、バックエンドサーバーが起動していることを確認してください
- シークレットモードを使用する場合は、メッセージの内容が暗号化されます
- ダークモードとライトモードは、UIの見た目を切り替えます

## トラブルシューティング
### よくある問題と解決方法

1. メッセージが表示されない場合
   - バックエンドサーバーが起動していることを確認
   - ブラウザの開発者ツールでエラーメッセージを確認
   - ログイン状態を確認

2. メッセージ送信時にエラーが発生する場合
   - バックエンドサーバーのログを確認
   - 認証トークンが有効か確認
   - ネットワーク接続を確認

3. フロントエンドサーバーが起動しない場合
   - ポート8081が他のプロセスで使用されていないか確認
   - 依存パッケージが正しくインストールされているか確認
   - Node.jsのバージョンを確認

4. バックエンドサーバーが起動しない場合
   - ポート8000が他のプロセスで使用されていないか確認
   - Pythonの仮想環境が有効になっているか確認
   - 必要なパッケージがすべてインストールされているか確認

### ログの確認方法

1. フロントエンドのログ
   - ブラウザの開発者ツール（F12）を開く
   - Consoleタブでエラーメッセージを確認
   - NetworkタブでAPIリクエストの状態を確認

2. バックエンドのログ
   - ターミナルでバックエンドサーバーの出力を確認
   - エラーメッセージや警告を確認
   - データベースの接続状態を確認

## 使用方法

### 1. ログイン
1. ブラウザで http://localhost:8080 にアクセス
2. 初期管理者アカウントでログイン
   - メールアドレス: admin@example.com
   - パスワード: admin123

### 2. チャット機能
- テキスト入力
  1. メッセージ入力欄にテキストを入力
  2. 「送信」ボタンをクリックまたはEnterキーを押す
  3. ボットの応答が1文字ずつ表示される

- 音声入力
  1. 「音声ファイル」ボタンから音声ファイルをアップロード
  2. または、マイクアイコンをクリックして録音開始（最大5秒）
  3. 音声が自動的にテキストに変換され、送信される

### 3. 感情分析
- ボットの応答には感情分析の結果が表示されます
- 感情の種類と確率が表示され、より自然な対話を実現

### 4. 音声出力
- ボットの応答は自動的に音声で再生されます
- 音声は日本語で自然な発話を実現

## 注意事項
- 音声録音機能を使用するには、ブラウザのマイク使用許可が必要です
- 音声ファイルはWAV形式を推奨します
- 長時間の対話では、ブラウザのキャッシュをクリアすることをお勧めします 

## UI/UXガイドライン

### 1. チャットインターフェースの特徴
- 固定表示の入力欄
  - 画面下部に常に表示
  - スクロールしても位置が固定
  - 最小高さ80px、最大高さ120px
  - 入力欄の潰れを防止

### 2. レイアウトの最適化
- メッセージ表示エリア
  - 下部に140pxの余白確保
  - スムーズスクロール対応
  - タッチデバイス対応
- 入力コンポーネント
  - テキスト入力欄: 40-80px
  - 音声入力ボタン: 180px固定幅
  - 送信ボタン: 40x40px

### 3. 表示の安定性確保
- z-indexの適切な設定
  - 入力欄: z-index 100
  - メッセージ: 通常レイヤー
- ボックスシャドウ効果
  - 入力欄の視認性向上
  - 2pxのシャドウ効果

### 4. トラブルシューティング
- 入力欄が潰れる場合
  1. ブラウザのキャッシュをクリア
  2. 開発サーバーを再起動
  ```bash
  # フロントエンド開発サーバーの再起動
  cd chatbot/frontend
  npm run dev
  ```
- レイアウトが崩れる場合
  1. 画面をリロード
  2. ブラウザのズームを100%に設定
  3. 開発者ツールでエラーを確認

### 5. パフォーマンス最適化
- レイアウト計算の効率化
- スクロール処理の最適化
- メモリ使用量の制御
- 表示更新の効率化 

## 再起動手順

### バックエンドの再起動
```bash
# バックエンドディレクトリに移動
cd backend

# 既存のプロセスを終了（Windows）
taskkill /F /IM python.exe
# 既存のプロセスを終了（Linux/Mac）
pkill -f "python main.py"

# 仮想環境の有効化（まだ有効化されていない場合）
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# サーバーの再起動
python main.py
```

### フロントエンドの再起動
```bash
# フロントエンドディレクトリに移動
cd frontend

# 既存のプロセスを終了（Windows）
taskkill /F /IM node.exe
# 既存のプロセスを終了（Linux/Mac）
pkill -f "npm run dev"

# 開発サーバーの再起動
npm run dev
```

注意事項：
- バックエンドとフロントエンドの両方を再起動することで、最新の変更が反映されます
- データベースの変更がある場合は、バックエンドの再起動時に自動的に適用されます
- 環境変数の変更がある場合は、必ず再起動が必要です 

## チャットデータの保存

### 1. データベース構造
チャットデータは以下のテーブルに保存されます：
- `messages`: 個々のメッセージデータ
  - `id`: メッセージID
  - `user_id`: 送信者のユーザーID
  - `content`: メッセージ内容
  - `role`: メッセージの役割（'user' または 'assistant'）
  - `created_at`: 作成日時
  - `is_secret`: シークレットモードフラグ

### 2. APIエンドポイント
チャットデータの操作には以下のエンドポイントを使用します：

```bash
# メッセージの送信
POST /api/chat
{
  "message": "こんにちは",
  "is_secret": false
}

# メッセージ履歴の取得
GET /api/messages

# メッセージの検索
POST /api/messages/search
{
  "query": "検索キーワード",
  "start_date": "2024-03-01",
  "end_date": "2024-03-31"
}
```

### 3. フロントエンドの実装
メッセージの送信と保存は以下のように実装されています：

```javascript
// メッセージの送信
async sendMessage() {
  if (!this.newMessage.trim()) return

  const userMessage = {
    role: 'user',
    content: this.newMessage
  }

  try {
    const response = await axios.post('/api/chat', {
      message: userMessage.content,
      is_secret: this.isSecretMode
    })
    // レスポンスの処理
  } catch (error) {
    console.error('Error:', error)
  }
}

// メッセージ履歴の取得
async loadMessages() {
  try {
    const response = await axios.get('/api/messages')
    this.messages = response.data.messages
  } catch (error) {
    console.error('Error loading messages:', error)
  }
}
```

### 4. データの永続化
- 通常モード：すべてのメッセージがデータベースに保存
- シークレットモード：メッセージは一時的にのみ保持され、データベースには保存されない

### 5. バックアップとリカバリ
```bash
# データベースのバックアップ
sqlite3 chatbot.db ".backup 'backup.db'"

# バックアップからの復元
sqlite3 chatbot.db ".restore 'backup.db'"
```

### 6. 注意事項
- シークレットモードでのメッセージは保存されません
- データベースのバックアップは定期的に行うことを推奨
- 本番環境では適切なデータベース設定とバックアップ戦略が必要

## 注意事項
1. バックエンドサーバー（FastAPI）は必ずポート8000で起動してください
2. 初期管理者アカウントのパスワードは必ず変更してください
3. 本番環境では適切なセキュリティ設定を行ってください

## トラブルシューティング
1. ログインできない場合
   - バックエンドサーバーが起動していることを確認
   - ポート番号が8000であることを確認
   - 認証情報が正しいことを確認

2. 管理画面にアクセスできない場合
   - 管理者権限が正しく設定されているか確認
   - ログアウト後に再度ログインを試す

3. メトリクスが表示されない場合
   - ブラウザの開発者ツールでネットワークエラーを確認
   - バックエンドのログを確認

## フロントエンドのセットアップ

### 1. 環境の準備
```bash
# プロジェクトディレクトリに移動
cd chatbot/frontend

# 依存パッケージのインストール
npm install
# または
yarn install
```

### 2. 開発サーバーの起動
```bash
# 開発サーバーの起動
npm run serve
# または
yarn serve
```

フロントエンドサーバーが起動すると、以下のURLでアクセス可能になります：
- ローカル: http://localhost:8081
- ネットワーク: http://[あなたのIPアドレス]:8081

## 注意事項
- フロントエンドは8081ポートで動作します
- バックエンドは8000ポートで動作します
- メッセージの送信時は、バックエンドサーバーが起動していることを確認してください
- シークレットモードを使用する場合は、メッセージの内容が暗号化されます
- ダークモードとライトモードは、UIの見た目を切り替えます

## 使用方法

### 1. ログイン
1. ブラウザで http://localhost:8080 にアクセス
2. 初期管理者アカウントでログイン
   - メールアドレス: admin@example.com
   - パスワード: admin123

### 2. チャット機能
- テキスト入力
  1. メッセージ入力欄にテキストを入力
  2. 「送信」ボタンをクリックまたはEnterキーを押す
  3. ボットの応答が1文字ずつ表示される

- 音声入力
  1. 「音声ファイル」ボタンから音声ファイルをアップロード
  2. または、マイクアイコンをクリックして録音開始（最大5秒）
  3. 音声が自動的にテキストに変換され、送信される

### 3. 感情分析
- ボットの応答には感情分析の結果が表示されます
- 感情の種類と確率が表示され、より自然な対話を実現

### 4. 音声出力
- ボットの応答は自動的に音声で再生されます
- 音声は日本語で自然な発話を実現

## 注意事項
- 音声録音機能を使用するには、ブラウザのマイク使用許可が必要です
- 音声ファイルはWAV形式を推奨します
- 長時間の対話では、ブラウザのキャッシュをクリアすることをお勧めします 

## UI/UXガイドライン

### 1. チャットインターフェースの特徴
- 固定表示の入力欄
  - 画面下部に常に表示
  - スクロールしても位置が固定
  - 最小高さ80px、最大高さ120px
  - 入力欄の潰れを防止

### 2. レイアウトの最適化
- メッセージ表示エリア
  - 下部に140pxの余白確保
  - スムーズスクロール対応
  - タッチデバイス対応
- 入力コンポーネント
  - テキスト入力欄: 40-80px
  - 音声入力ボタン: 180px固定幅
  - 送信ボタン: 40x40px

### 3. 表示の安定性確保
- z-indexの適切な設定
  - 入力欄: z-index 100
  - メッセージ: 通常レイヤー
- ボックスシャドウ効果
  - 入力欄の視認性向上
  - 2pxのシャドウ効果

### 4. トラブルシューティング
- 入力欄が潰れる場合
  1. ブラウザのキャッシュをクリア
  2. 開発サーバーを再起動
  ```bash
  # フロントエンド開発サーバーの再起動
  cd chatbot/frontend
  npm run dev
  ```
- レイアウトが崩れる場合
  1. 画面をリロード
  2. ブラウザのズームを100%に設定
  3. 開発者ツールでエラーを確認

### 5. パフォーマンス最適化
- レイアウト計算の効率化
- スクロール処理の最適化
- メモリ使用量の制御
- 表示更新の効率化 

## 再起動手順

### バックエンドの再起動
```bash
# バックエンドディレクトリに移動
cd backend

# 既存のプロセスを終了（Windows）
taskkill /F /IM python.exe
# 既存のプロセスを終了（Linux/Mac）
pkill -f "python main.py"

# 仮想環境の有効化（まだ有効化されていない場合）
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# サーバーの再起動
python main.py
```

### フロントエンドの再起動
```bash
# フロントエンドディレクトリに移動
cd frontend

# 既存のプロセスを終了（Windows）
taskkill /F /IM node.exe
# 既存のプロセスを終了（Linux/Mac）
pkill -f "npm run dev"

# 開発サーバーの再起動
npm run dev
```

注意事項：
- バックエンドとフロントエンドの両方を再起動することで、最新の変更が反映されます
- データベースの変更がある場合は、バックエンドの再起動時に自動的に適用されます
- 環境変数の変更がある場合は、必ず再起動が必要です 